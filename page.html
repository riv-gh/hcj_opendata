<style>
	#opendata {
		font-size: 2em;
	}
	#opendata #preload {
		height: 150px;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	#opendata #preload div {
		width: 60px;
		height: 60px;
		border: 20px solid;
		border-image-source: linear-gradient(to left, #005caa, #005caa);
		animation: rotating 2s linear infinite;
	}
	@keyframes rotating {
		0% {
			transform: rotate(0deg) scale(1);;
		}
		50%{
			transform: rotate(90deg) scale(0.8)
		}
		100% {
			transform: rotate(180deg) scale(1);
		}
	}
	#opendata .hide {
		display: none;
	}
</style>
<div id="opendata">
	<ul id="links" class="hide">
		<li>
			<a 
				href="#"
				data-path="/offense"
				data-pages="0"
				data-filename="offense.json"
			>
				Перелік суддів, звільнених ВРП за скоєння істотного дисциплінарного проступку
			</a>
		</li>
		<li>
			<a 
				href="#"
				data-path="/release"
				data-pages="0"
				data-filename="release.json"
			>
				Відсторонення від здійснення правосуддя
			</a>
		</li>
		<li>
			<a 
				href="#"
				data-path="/intervention"
				data-pages="0"
				data-filename="intervention.json"
			>
				Реєстр повідомлень суддів про втручання в діяльність
			</a>
		</li>
	</ul>
	<div id="preload">
		<div></div>
	</div>
	<div id="result" class="hide">
		<input type="text" value="offense.json" readonly="readonly">
		<button>Завантажити</button>
		<div>Попередній перегляд:</div>
		<pre id="output">
		[
			{
				"№": "1",
				"Дата надходження": "11.04.2023",
				"Справа № / документ": "289/0/6-23",
				"Прізвище, ім’я, по батькові судді": "Хейло Я.В., Тимченко О.О., Мірута О.А.,",
				"Назва суду": "Дніпровський апеляційний суд",
				"Результат перевірки - рішення ВРП": "",
				"Реагування на рішення ВРП": "",
				"Автор звернення": "",
				"Доповідач": ""
			},
			{
				"№": "2",
				"Дата надходження": "10.04.2023",
				"Справа № / документ": "274/0/6-23",
				"Прізвище, ім’я, по батькові судді": "Чайкіна О.В.",
				"Назва суду": "Дзержинський районний суд м. Кривого Рогу Дніпропетровської області",
				"Результат перевірки - рішення ВРП": "",
				"Реагування на рішення ВРП": "",
				"Автор звернення": "",
				"Доповідач": ""
			},
			{
				"№": "3",
				"Дата надходження": "10.04.2023",
				"Справа № / документ": "275/0/6-23",
				"Прізвище, ім’я, по батькові судді": "Ільніцька О.М.",
				"Назва суду": "Балтський районний суд Одеської області",
				"Результат перевірки - рішення ВРП": "",
				"Реагування на рішення ВРП": "",
				"Автор звернення": "",
				"Доповідач": ""
			},
			...
		]
		</pre>
	</div>
</div>
<script>
	const linksConainer = document.querySelector('#opendata #links')
	const preloadContainer = document.querySelector('#opendata #preload')
	const resultContainer = document.querySelector('#opendata #result')

	const pre = document.querySelector('#opendata #output')

	const linksEl = Array.from(linksConainer.querySelectorAll('a'))
	const links = linksEl.map(a=>a.dataset['path'])

	Promise.all(links.map(url =>
		fetch(url)
		.then(response => response.text())
		.then((html) => {
			const parser = new DOMParser();
			const doc = parser.parseFromString(html, 'text/html');
			const count = +doc.querySelector('.pager-last>a').href.split('=')[1]+1
			linksEl.filter(a=>a.dataset['path']===url)[0].dataset['pages'] = count
			//console.log(url, count)
		})
	)).then(data => {
		hide(preloadContainer)
		show(linksConainer)
	})


	linksConainer.addEventListener('click',(event)=>{
		event.preventDefault()
		hide(resultContainer)
		show(preloadContainer)
		const count = +event.target.dataset['pages']
		const linkTpl = event.target.dataset['path']+'?page='
		const links = (new Array(count))
		.fill(0)
		.map((el,i)=>linkTpl+i)

		let main_arr = []
		let err_arr = []
		Promise.all(links.map(url =>
			fetch(url)
			.then(response => response.text())
			.then((html) => {
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, 'text/html');
				const tr_arr = Array.from(doc.querySelectorAll('#block-system-main>div>div>div.view-content>div>table>tbody>tr'))
				try {
					const subUrl = url.split('?')[0]
					main_arr = main_arr.concat(
						subUrl==='/offense'
						? 
							tr_arr.map(tr=>({
								"№": tr.querySelector('.views-field-counter').textContent.trim(),
								"Прізвище, ім’я, по батькові судді": tr.querySelector('.views-field-title').textContent.trim(),
								"Назва суду": tr.querySelector('.views-field-field-court-name').textContent.trim(),
								"Дата прийняття рішення палатою / Дата рішення ВККСУ": tr.querySelector('.views-field-field-date').textContent.trim(),
								"Номер рішення палати / Номер рекомендації ВККСУ": tr.querySelector('.views-field-field-number').textContent.trim(),
								"Дата та номер рішення ВРП": tr.querySelector('.views-field-field-date-iso').textContent.trim()+'\n№ '+tr.querySelector('.views-field-field-number-1').textContent.trim(),
								"Дата рішення ВРП": tr.querySelector('.views-field-field-date-iso').textContent.trim(),
								"Номер рішення ВРП": tr.querySelector('.views-field-field-number-1').textContent.trim(),
								"Автор звернення": tr.querySelector('.views-field-field-complainant').textContent.trim(),
								"Доповідач": tr.querySelector('.views-field-field-narrator').textContent.trim(),
							}))
						:
							subUrl==='/release'
							? 
								{ "none": "/release"}	
							:
								subUrl==='/intervention'
								? 
									{ "none": "/intervention"}	
								:
									{ "none": "none"}	

							

					)
				}
				catch (err) {
					err_arr.push({link: url, html: tr_arr, error: err,})
				}
			})
		)).then(data => {
			main_arr = main_arr.sort((a,b)=>a["№"]-b["№"])
			const json = JSON.stringify(main_arr, null, '\t')
			console.log(json)
			pre.textContent = json
			hide(preloadContainer)
			show(resultContainer)
		})

	})


	function hide(el, hideClass='hide') {
		el.classList.add(hideClass)
	}
	function show(el, hideClass='hide') {
		el.classList.remove(hideClass)
	}
	function download(filename, text) {
		const element = document.createElement('a');
		element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
		element.setAttribute('download', filename);
		element.style.display = 'none';
		document.body.appendChild(element);
		element.click();
		document.body.removeChild(element);
	}

</script>
